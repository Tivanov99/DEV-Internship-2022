USE [PhoneBook]

CREATE OR ALTER PROCEDURE SP_ADD_TABLE_DESCRIPTION
(
    @TABLE_NAME NVARCHAR,
    @TABLE_DESCRIPTION NVARCHAR
)
AS
BEGIN
    SELECT CONCAT(@TABLE_NAME,'_TABLE_DESCRIPTION') AS DESCRIPTION_NAME

    EXEC SP_ADDEXTENDEDPROPERTY @NAME=DESCRIPTION_NAME,
                                @VALUE=@TABLE_DESCRIPTION,
                                @LEVEL0TYPE=N'SCHEMA',
                                @LEVEL0NAME=N'DBO',
                                @LEVEL1TYPE=N'TABLE',
                                @LEVEL1NAME=@TABLE_NAME
END

CREATE OR ALTER PROCEDURE SP_ADD_COLUMN_DESCRIPTION
(
	@TABLE_NAME NVARCHAR,
	@COLUMN_NAME NVARCHAR,
	@COLUMN_DESCRIPTION NVARCHAR
)
AS
BEGIN
	exec sp_AddExtendedProperty'MS_Description',@COLUMN_DESCRIPTION,
								'TABLE', @TABLE_NAME,
								'COLUMN', @COLUMN_NAME
END

DROP TABLE IF EXISTS [PHONE_NUMBERS]
DROP TABLE IF EXISTS [PERSONS]
DROP TABLE IF EXISTS [CITIES]
DROP TABLE IF EXISTS [PHONE_TYPES]

exec sp_columns  [PHONE_NUMBERS] 


CREATE TABLE
	[CITIES]
	(
		[ID] INT IDENTITY (1,1) NOT NULL,
		[UPDATE_COUNTER] INT NOT NULL,
		[CITY_NAME] NVARCHAR(32)NOT NULL,
		[AREA_NAME] NVARCHAR(32)NOT NULL,
		[POSTAL_CODE] INT NOT NULL,
		CONSTRAINT [PK_CITIES_ID]
		PRIMARY KEY ([ID])
	)

EXEC SP_ADD_TABLE_DESCRIPTION 'CITIES','Таблица съдържаща инфрормацията за градовете.'
EXEC SP_ADD_COLUMN_DESCRIPTION 'CITIES','ID','Уникален идентификатор на запис в таблицата (32)бита'
EXEC SP_ADD_COLUMN_DESCRIPTION 'CITIES','UPDATE_COUNTER','Версия на ред (32)бита (задължителен запис)'
EXEC SP_ADD_COLUMN_DESCRIPTION 'CITIES','CITY_NAME','Таблица съдържаща (задължителен запис) областите (512)бита'
EXEC SP_ADD_COLUMN_DESCRIPTION 'CITIES','AREA_NAME','Таблица съдържаща (задължителен запис) областите (512)бита'
EXEC SP_ADD_COLUMN_DESCRIPTION 'CITIES','POSTAL_CODE','Таблица съдържаща (задължителен запис) пощенските кодове (32)бита'

CREATE UNIQUE INDEX UX_CITIES_CITY_NAME ON [CITIES]([CITY_NAME])

CREATE NONCLUSTERED INDEX IX_CITIES_CITY_NAME
ON [CITIES]([CITY_NAME] ASC)

CREATE NONCLUSTERED INDEX IX_CITIES__AREA_NAME
ON [CITIES]([AREA_NAME] ASC)



CREATE TABLE
	[PHONE_TYPES]
	(
		[ID] INT IDENTITY (1,1) NOT NULL,
		[UPDATE_COUNTER] INT NOT NULL,
		[PHONE_TYPE] VARCHAR(16) UNIQUE NOT NULL,
		CONSTRAINT [PK_PHONE_TYPES_ID]
		PRIMARY KEY ([ID])
	)

EXEC SP_ADD_TABLE_DESCRIPTION 'PHONE_TYPES','Таблица съдържаща инфрормацията за типовете телефони.'
EXEC SP_ADD_COLUMN_DESCRIPTION 'PHONE_TYPES','ID','Уникален идентификатор на запис в таблицата (32)бита'
EXEC SP_ADD_COLUMN_DESCRIPTION 'PHONE_TYPES','UPDATE_COUNTER','Версия на ред (32)бита (задължителен запис)'
EXEC SP_ADD_COLUMN_DESCRIPTION 'PHONE_TYPES','PHONE_TYPE','Колона съдържаща (задължителен запис) типовете телефони (128)бита'


CREATE UNIQUE INDEX UX_PHONE_TYPES_PHONE_TYPE ON [PHONE_TYPES]([PHONE_TYPE])


CREATE TABLE
	[PERSONS]
	(
		[ID] INT IDENTITY (1,1) NOT NULL,
		[UPDATE_COUNTER] INT NOT NULL,
		[FIRST_NAME] NVARCHAR(32) NOT NULL,
		[SECOND_NAME] NVARCHAR(32) NOT NULL,
		[LAST_NAME] NVARCHAR(32) NOT NULL,
		[UCN] NVARCHAR(16) NOT NULL,		
		[CITY_ID] INT NOT NULL,
		[ADDRESS] NVARCHAR(256) NOT NULL,
		CONSTRAINT [PK_PERSONS_ID]
		PRIMARY KEY ([ID])
	)
EXEC SP_ADD_TABLE_DESCRIPTION 'PERSONS','Таблица съдържаща инфрормацията за хора.'
EXEC SP_ADD_COLUMN_DESCRIPTION 'PERSONS','UPDATE_COUNTER','Версия на ред (32)бита (задължителен запис)'
EXEC SP_ADD_COLUMN_DESCRIPTION 'PERSONS','FIRST_NAME','Таблица съхраняваща (задължителен запис) името (256)бита'
EXEC SP_ADD_COLUMN_DESCRIPTION 'PERSONS','SECOND_NAME','Таблица съхраняваща (задължителен запис) презимето (256)бита'
EXEC SP_ADD_COLUMN_DESCRIPTION 'PERSONS','LAST_NAME','Таблица съхраняваща (задължителен запис) фамилията (256)бита'
EXEC SP_ADD_COLUMN_DESCRIPTION 'PERSONS','CITY_ID','Задължителен вторичен ключ рефериращ таблицата "CITTIES" и колоната "ID"  (64)бита'
EXEC SP_ADD_COLUMN_DESCRIPTION 'PERSONS','UCN','Таблица съхраняваща (задължителен запис) егн-то (64)бита'
EXEC SP_ADD_COLUMN_DESCRIPTION 'PERSONS','ADDRESS','Таблица съхраняваща (задължителен запис) егн-то (512)бита'


CREATE NONCLUSTERED INDEX IX_PERSONS_FIRST_AND_LAST_NAME
ON [PERSONS]([FIRST_NAME], [LAST_NAME] ASC)

CREATE NONCLUSTERED INDEX IX_PERSONS_EGN
ON [PERSONS]([UCN] ASC)

ALTER TABLE [PERSONS]
ADD CONSTRAINT [FK_PERSONS_CITY_ID] 
		FOREIGN KEY ([CITY_ID])
		REFERENCES [CITIES]([ID])

CREATE TABLE
	[PHONE_NUMBERS]
	(
		[ID] INT IDENTITY (1,1) NOT NULL, 
		[UPDATE_COUNTER] INT NOT NULL,
		[PERSON_ID] INT NOT NULL,
		[PHONE_TYPE_ID] INT NOT NULL,
		[PHONE_NUMBER] VARCHAR(16) NOT NULL UNIQUE,
		CONSTRAINT [PK_PHONE_NUMBERS_ID]
			PRIMARY KEY([ID])
	)

EXEC SP_ADD_TABLE_DESCRIPTION 'PHONE_NUMBERS','Таблица съдържаща инфрормацията за телефонни номера, типове телефони и хора.'
EXEC SP_ADD_COLUMN_DESCRIPTION 'PHONE_NUMBERS','ID','Уникален идентификатор на запис в таблицата (32)бита'
EXEC SP_ADD_COLUMN_DESCRIPTION 'PHONE_NUMBERS','UPDATE_COUNTER','Версия на ред (32)бита (задължителен запис)'
EXEC SP_ADD_COLUMN_DESCRIPTION 'PHONE_NUMBERS','PERSON_ID','Задължителен вторичен ключ рефериращ таблицата "PERSONS" и колоната "ID"  (64)бита'
EXEC SP_ADD_COLUMN_DESCRIPTION 'PHONE_NUMBERS','PHONE_TYPE_ID','Задължителен вторичен ключ рефериращ таблицата "PHONE_NUMBERS" и колоната "ID"  (64)бита'
EXEC SP_ADD_COLUMN_DESCRIPTION 'PHONE_NUMBERS','PHONE_NUMBER','Таблица съхраняваща (задължителен запис) телефонен номер (32)бита'


ALTER TABLE [PHONE_NUMBERS]
ADD CONSTRAINT [FK_PHONE_NUMBERS_PERSON_ID]
			FOREIGN KEY  ([PERSON_ID]) 
			REFERENCES [PERSONS] ([ID])
			ON DELETE CASCADE,

CONSTRAINT [FK_PHONE_NUMBERS_PHONE_TYPE_ID]
			FOREIGN KEY ([PHONE_TYPE_ID])
			REFERENCES [PHONE_TYPES] ([ID])

CREATE NONCLUSTERED INDEX IX_PHONE_NUMBERS_PHONE_NUMBER
ON [PHONE_NUMBERS]([PHONE_NUMBER] ASC)



